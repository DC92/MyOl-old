<!DOCTYPE html>
<html>
  <head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>My Openlayers</title>

	<!-- Openlayers -->
	<link  href="ol-dist/ol.css" type="text/css" rel="stylesheet">
	<!--script src="http://openlayers.org/en/latest/build/ol-debug.js"></script-->
	<script src="ol-dist/ol-debug.js"></script>

	<!-- Recherche par nom -->
	<link  href="geocoder/ol3-geocoder.css" type="text/css" rel="stylesheet">
	<script src="geocoder/ol3-geocoder.js"></script>

	<!-- Proj4 -->
	<script src="proj4.js"></script>

	<!-- Dominique -->
	<script type="text/javascript" src="myol.js"></script>
	<style>
		.ol-coordinate {
			bottom: 30px;
			left: 8px;
			position: absolute;
			border-radius: 3px;
			font-size: small;
			color: white;
			background-color: rgba(0, 60, 136, 0.3);
			padding: 0 2px;
		}

		.ol-geocoder .gcd-txt-input {
			padding-right: 5px;
		}
		.ol-geocoder .gcd-txt-control {
			height: 2em;
		}
		.ol-geocoder.gcd-txt-container {
			width: 50%;
		}

		.ol-full-screen {
			top: 4em;
			left: .5em;
			right: auto;
		}

		.ol-geocoder.gcd-gl-container {
			top: 6em;
		}
		.ol-geocoder .gcd-gl-btn {
			width: 1.375em;
			height: 1.375em;
		}
  
		.switch-layer {
			font-size: small;
			max-height: 100%;
			overflow-y: scroll;
		}
		.switch-layer input {
			margin: 0;
			position: relative;
			top: 2px;
		}
		.switch-layer:hover {
			background-color: white;
		}
		.overpass-popup{
			background-color: #def;
			padding: 5px;
			border-radius: 5px;
    border: 1px solid #abc;
	}
		.overpass-popup p{
			font-size: small;
			margin: 0;
		}
.overpass-popup p:first-letter {
    text-transform: uppercase;
}
	</style>
</head>
<body>
	<!--input id="range" type="range" min="0" max="100" value="50" oninput="layerSelection()" /-->

	<div id="map" class="map"></div>
	<div id="lonlat"></div>
	<div id="edit-lonlat"></div>
	<!--select multiple="multiple" class="layerselect" id="layer-select" style="overflow-y:hidden" onchange="layerSelection()"></select-->
	<div>Ctrl+click:couches multiples</div>
	<textarea id="geojson" rows="25" cols="80">
		{
			"type": "FeatureCollection",
			"features": [{
				"type": "Feature",
				"geometry": {"type":"MultiLineString","coordinates":[[[-4.35022,47.78254],[-4.3667,47.78992],[-4.32825,47.86368],[-4.47656,47.9778],[-4.72375,48.06965],[-4.31177,48.12101],[-4.26782,48.18332],[-4.56445,48.20163],[-4.63586,48.29308],[-4.23486,48.33326],[-4.49304,48.38436],[-4.86383,48.3111],[-4.84186,48.59164],[-4.46008,48.63546],[-4.00964,48.71164],[-3.76245,48.70439],[-3.57019,48.67901],[-3.58118,48.83834],[-3.14172,48.86364],[-2.6803,48.5228],[-2.79565,47.57172],[-3.13623,47.58284],[-3.66357,47.78992],[-4.14697,47.76408],[-4.35022,47.78254]]]}
			}]
		}
	</textarea>

<script>
/*
BUGS
Click editeur = charge une page undefined !!!!
fullscreen
	pas toute la page !
	les icones ne sont pas ou est le hover

BUGS MOBILES

TEST
Voir traffic réseau (autre couche = ord survey ??)
mobiles ! boutons trop grand ou trop pres
https

TODO
GeoJSON Ajax filtre / paramètres
	setURL geojson
	setRequest OVERPASS
check , à la fin des tablos
mem cookie couches overlay
Locales
upload GPX
	https://gis.stackexchange.com/questions/175592/read-gpx-file-from-desktop-in-openlayers-3
download GPX
	https://gis.stackexchange.com/questions/53934/save-gpx-from-drawn-feature-in-openlayers

BEST
Superzoom
Harmoniser buttonXxxx yyyElement ...
Site off line, application
*/

// LA CARTE ------------------------------------------------
var IGNkey = 'o6owv8ubhn3vbz2uj8jq5j0z'; // localhost
//var IGNkey = 'hcxdz5f1p9emo4i1lch6ennl'; // chemineur.fr
var thunderforestKey = 'a54d38a8b23f435fa08cfb1d0d0b266e'; // https://manage.thunderforest.com
var bingKey = 'ArLngay7TxiroomF7HLEXCS7kTWexf1_1s1qiF7nbTYs2IkD3XLcUnvSlKbGRZxt';

var baseLayers = {
	'OSM-FR': OSMlayer('//{a-c}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png'),
	'OSM': OSMlayer('//{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
	'MRI': OSMlayer('//maps.refuges.info/hiking/{z}/{x}/{y}.png', '<a href="http://wiki.openstreetmap.org/wiki/Hiking/mri">MRI</a>'),
	'Hike & Bike': OSMlayer('http://{a-c}.tiles.wmflabs.org/hikebike/{z}/{x}/{y}.png', '<a href="http://www.hikebikemap.org/">hikebikemap.org</a>'), // Not on https
	'Autriche': kompassLayer('KOMPASS Touristik'),
	'OSM-outdoors': thunderforestLayer('outdoors', thunderforestKey),
	'OSM-cycle': thunderforestLayer('cycle', thunderforestKey),
	'OSM-landscape': thunderforestLayer('landscape', thunderforestKey),
	'OSM-transport': thunderforestLayer('transport', thunderforestKey),
	'IGN': ignLayer(IGNkey, 'GEOGRAPHICALGRIDSYSTEMS.MAPS'),
	'IGN photos': ignLayer(IGNkey, 'ORTHOIMAGERY.ORTHOPHOTOS'),
	'IGN TOP 25': ignLayer(IGNkey, 'GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN-EXPRESS.STANDARD'),
	'IGN classique': ignLayer(IGNkey, 'GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN-EXPRESS.CLASSIQUE'),
	// NOT YET	ignLayer('IGN avalanches', IGNkey,'GEOGRAPHICALGRIDSYSTEMS.SLOPES.MOUNTAIN'),
	'Cadastre': ignLayer(IGNkey, 'CADASTRALPARCELS.PARCELS', 'image/png'),
	'Swiss': swissLayer('ch.swisstopo.pixelkarte-farbe'),
	'Swiss photo': swissLayer('ch.swisstopo.swissimage'),
	'Espagne': spainLayer('mapa-raster', 'MTN'),
	'Espagne photo': spainLayer('pnoa-ma', 'OI.OrthoimageCoverage'),
	'Italie': igmLayer(),
	'Angleterre': osLayer(bingKey),
	'Bing': bingLayer('Road', bingKey),
	'Bing photo': bingLayer('Aerial', bingKey),
	'Google road': googleLayer('m'),
	'Google terrain': googleLayer('p'),
	'Google photo': googleLayer('s'),
	'Google hybrid': googleLayer('s,h'),
	Stamen: stamenLayer('terrain'),
	Watercolor: stamenLayer('watercolor'),
	'Neutre': new ol.layer.Tile()
};

var overLayers = {
	WRI: pointsWriLayer(),
	Massifs: massifsWriLayer(),
	Chemineur: geoJsonLayer({
		url: 'http://chemineur.fr/ext/Dominique92/GeoBB/gis.php?site=this&poi=3,8,16,20,23,28,30,40,44,64,58,62',
		properties: function(property) {
			return {
				styleImage: property.icone,
				hoverText: property.nom,
				clickUrl: property.url
			}
		}
	}),
	OverPass: overpassLayer({
		// icon_name: '[overpass selection]'
		ravitaillement: '["shop"~"supermarket|convenience"]',
		bus: '["highway"="bus_stop"]',
		parking: '["amenity"="parking"]["access"!="private"]',
		camping: '["tourism"="camp_site"]',
		'refuge-garde': '["tourism"="alpine_hut"]',
		'cabane-non-gardee': '["building"="cabin"]',
		abri: '["amenity"="shelter"]',
		hotel: '["tourism"~"hotel|guest_house|chalet|hostel|apartment"]',
	})
}

var controls = [
	controlLayers(baseLayers, overLayers),
	new ol.control.Zoom(),
	new ol.control.Attribution({
		collapsible: false // Attribution toujours ouverte
	}),
	//TBD BUG full screen limité en hauteur (chrome, mobile, ...)
	new ol.control.FullScreen({
		label: '\u21d4',
		labelActive: '\u21ce',
		tipLabel: 'Plein écran'
	}),
	new ol.control.ScaleLine(),
	new ol.control.MousePosition({
		coordinateFormat: ol.coordinate.createStringXY(5),
		projection: 'EPSG:4326',
		className: 'ol-coordinate'
	}),
	permalink({
		init: true,
		invisible: false
	}),
	// https://github.com/jonataswalker/ol-geocoder
	new Geocoder('nominatim', {
		provider: 'osm',
		lang: 'FR',
		placeholder: 'Recherche par nom' // Initialisation du champ de saisie
	}),
	buttonGPS(),
	controlButton('&equiv;', {
		title: 'Imprimer la carte',
		action: function() {
			window.print();
		}
	})
];

var map = new ol.Map({
	target: 'map',
	//	loadTilesWhileInteracting: true,
	controls: controls,
	view: new ol.View({
		//center: ol.proj.fromLonLat([-3.5, 48.25]), // France
		center: ol.proj.fromLonLat([7, 47]), // Suisse
		//center: ol.proj.fromLonLat([9.2, 45.5]), // Milan
		//center: ol.proj.fromLonLat([7.07, 45.19]), // Rochemelon
		//center: ol.proj.fromLonLat([-.1, 51.5]), // Londres
		zoom: 8
	})
});

//TEST
var viseur = marqueur('images/viseur.png', [6.15, 46.2], 'edit-lonlat', [
	'Lon <input type="text" onchange="viseur.edit(this,0,4326)" size="12" maxlength="12" value="{0}"/>' +
	'<br/>Lat <input type="text" onchange="viseur.edit(this,1,4326)" size="12" maxlength="12" value="{1}"/>',
	'<br/>X <input type="text" onchange="viseur.edit(this,0,21781)" size="12" maxlength="12" value="{2}"/>' +
	'<br/>Y <input type="text" onchange="viseur.edit(this,1,21781)" size="12" maxlength="12" value="{3}"/>'
], 'edit');
map.addLayer(viseur);

map.addLayer(marqueur('images/cadre.png', [-.575, 44.845], 'lonlat', ['Lon {0}, Lat {1}', '<br/>X {2}, Y {3} (CH1903)']));

if(overLayers.Massifs)
	map.addLayer(lineEditor('geojson', [overLayers.Massifs]));

	</script>
  </body>
</html>
